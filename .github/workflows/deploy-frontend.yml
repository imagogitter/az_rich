name: Deploy frontend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      BACKEND_STORAGE_ACCOUNT: ${{ secrets.BACKEND_STORAGE_ACCOUNT }}
      BACKEND_CONTAINER: ${{ secrets.BACKEND_CONTAINER }}
      BACKEND_KEY: ${{ secrets.BACKEND_KEY }}
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
      KEY_VAULT_NAME: ${{ secrets.KEY_VAULT_NAME }}
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Docker build environment
        uses: docker/setup-buildx-action@v2

      - name: Make script executable
        run: chmod +x ./setup-frontend-complete.sh

      - name: Discover Azure resources and set env vars when missing
        run: |
          set -euo pipefail
          PROJECT_TAG="ai-inference"

          # Discover resource group if not provided
          if [ -z "${RESOURCE_GROUP:-}" ]; then
            RG=$(az group list --tag project=${PROJECT_TAG} --query "[0].name" -o tsv || echo "")
            if [ -n "$RG" ]; then
              echo "RESOURCE_GROUP=$RG" >> $GITHUB_ENV
              echo "Found resource group: $RG"
            fi
          fi

          # Discover Key Vault
          if [ -z "${KEY_VAULT_NAME:-}" ]; then
            KV=$(az resource list --tag project=${PROJECT_TAG} --query "[?type=='Microsoft.KeyVault/vaults']|[0].name" -o tsv || echo "")
            if [ -n "$KV" ]; then
              echo "KEY_VAULT_NAME=$KV" >> $GITHUB_ENV
              echo "Found Key Vault: $KV"
            fi
          fi

          # Discover Container Registry
          if [ -z "${REGISTRY_NAME:-}" ]; then
            ACR=$(az resource list --tag project=${PROJECT_TAG} --query "[?type=='Microsoft.ContainerRegistry/registries']|[0].name" -o tsv || echo "")
            if [ -n "$ACR" ]; then
              echo "REGISTRY_NAME=$ACR" >> $GITHUB_ENV
              echo "Found ACR: $ACR"
            fi
          fi

          # Discover Storage Account for Terraform backend
          if [ -z "${BACKEND_STORAGE_ACCOUNT:-}" ]; then
            SA=$(az resource list --tag project=${PROJECT_TAG} --query "[?type=='Microsoft.Storage/storageAccounts']|[0].name" -o tsv || echo "")
            if [ -n "$SA" ]; then
              echo "BACKEND_STORAGE_ACCOUNT=$SA" >> $GITHUB_ENV
              echo "Found storage account: $SA"
            fi
          fi

          # Defaults for backend container/key if still missing
          if [ -z "${BACKEND_CONTAINER:-}" ]; then
            echo "BACKEND_CONTAINER=tfstate" >> $GITHUB_ENV
            echo "Defaulting BACKEND_CONTAINER=tfstate"
          fi
          if [ -z "${BACKEND_KEY:-}" ]; then
            echo "BACKEND_KEY=ai-inference.tfstate" >> $GITHUB_ENV
            echo "Defaulting BACKEND_KEY=ai-inference.tfstate"
          fi

      - name: Run frontend deploy script
        id: deploy
        run: |
          ./setup-frontend-complete.sh \
            --backend-storage-account "$BACKEND_STORAGE_ACCOUNT" \
            --backend-container "$BACKEND_CONTAINER" \
            --backend-key "$BACKEND_KEY" \
            --resource-group "$RESOURCE_GROUP" \
            --keyvault "$KEY_VAULT_NAME" \
            --image-tag "$IMAGE_TAG" \
            --grant-acr-role \
            --force

      - name: Upload connection details
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: connection-details
          path: output/connection-details.txt
