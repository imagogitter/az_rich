# GitHub Actions Frontend Deployment Workflow

This document describes the automated frontend deployment workflow for the AI Inference Platform.

## Overview

The frontend deployment workflow (`frontend-deploy.yml`) automates the complete deployment process:
- Infrastructure provisioning via Terraform
- Frontend container build and deployment to Azure Container Registry
- Connection details retrieval and documentation
- Artifact generation with deployment information

## Triggers

The workflow runs automatically on:
- **Push to `main` branch** when changes are made to:
  - `frontend/**`
  - `terraform/**`
  - `setup-frontend-complete.sh`
  - `.github/workflows/frontend-deploy.yml`
- **Manual dispatch** via GitHub Actions UI

## Required Secrets

Configure these secrets in your GitHub repository (Settings → Secrets and variables → Actions):

### AZURE_CREDENTIALS (Required)

Azure service principal credentials in JSON format. To create:

```bash
# Find your subscription ID
az account show --query id -o tsv

# Replace with your subscription ID
SUBSCRIPTION_ID="your-subscription-id"

# Create service principal with contributor role
az ad sp create-for-rbac \
  --name "github-actions-ai-inference" \
  --role contributor \
  --scopes /subscriptions/$SUBSCRIPTION_ID \
  --sdk-auth
```

This outputs JSON like:
```json
{
  "clientId": "...",
  "clientSecret": "...",
  "subscriptionId": "...",
  "tenantId": "...",
  "activeDirectoryEndpointUrl": "...",
  "resourceManagerEndpointUrl": "...",
  "activeDirectoryGraphResourceId": "...",
  "sqlManagementEndpointUrl": "...",
  "galleryEndpointUrl": "...",
  "managementEndpointUrl": "..."
}
```

Copy the entire JSON output and add it as the `AZURE_CREDENTIALS` secret in GitHub.

### Optional Secrets

These are NOT required as secrets since they are generated by Terraform:
- `OPENAI_API_KEY` - Generated by Terraform and stored in Azure Key Vault
- `OPENAI_API_BASE_URL` - Derived from Function App hostname (output by Terraform)

## Workflow Steps

1. **Checkout repository** - Gets the latest code
2. **Validate secrets** - Ensures AZURE_CREDENTIALS is configured
3. **Setup Terraform** - Installs Terraform 1.5.0
4. **Setup Docker Buildx** - Prepares Docker for multi-platform builds
5. **Configure Azure credentials** - Logs into Azure using service principal
6. **Run deployment script** - Executes `setup-frontend-complete.sh`
7. **Handle errors** - Detects and reports common deployment issues
8. **Retrieve connection details** - Extracts outputs from Terraform
9. **Create artifacts** - Generates deployment documentation
10. **Display summary** - Shows results in GitHub UI

## Outputs

### Workflow Logs

The workflow displays:
- Frontend URL
- Resource group name
- Container app name
- API base URL
- Masked API key (first 8 characters)

### Artifacts

Download the `deployment-artifacts-<run-number>` artifact containing:

1. **connection-details.md** - Complete deployment information including:
   - Frontend URL and access instructions
   - LLM API configuration (API base URL, Key Vault commands)
   - Useful Azure CLI commands for management
   - Next steps and security notes

2. **deployment.log** - Full deployment script output

3. **output/** directory - Additional Terraform outputs (if generated)

### GitHub Summary

After successful deployment, the workflow creates a step summary with:
- Frontend URL (clickable link)
- Resource details
- Security notes
- Next steps

## Error Handling

The workflow includes specific error detection for:
- **Container Registry failures** - Checks quotas and permissions
- **Container App failures** - Verifies regional availability
- **Key Vault failures** - Detects naming conflicts or soft-deleted vaults
- **Docker push failures** - Validates ACR authentication

When errors occur, the workflow:
1. Displays specific error messages with guidance
2. Outputs the full deployment log
3. Fails the workflow to prevent incomplete deployments

## Manual Trigger

To manually trigger the workflow:

1. Go to your repository on GitHub
2. Click **Actions** tab
3. Select **Frontend Deployment** workflow
4. Click **Run workflow**
5. Select branch (default: `main`)
6. Optionally select environment (default: `production`)
7. Click **Run workflow**

## Post-Deployment Steps

After the workflow completes successfully:

1. **Download artifacts** to get connection details
2. **Visit the frontend URL** displayed in the summary
3. **Create admin account** (first user becomes admin)
4. **Run security script** locally to disable public signup:
   ```bash
   ./setup-frontend-auth.sh
   ```

## Retrieving LLM API Configuration

The LLM API configuration is automatically set up in the frontend container. To retrieve it for external use:

### API Base URL
```bash
cd terraform
FUNCTION_APP_NAME=$(terraform output -raw function_app_name)
echo "https://${FUNCTION_APP_NAME}.azurewebsites.net/api/v1"
```

### API Key
```bash
cd terraform
KEY_VAULT_NAME=$(terraform output -raw key_vault_name)
az keyvault secret show \
  --vault-name $KEY_VAULT_NAME \
  --name frontend-openai-api-key \
  --query value -o tsv
```

## Troubleshooting

### Workflow fails with "AZURE_CREDENTIALS secret is not set"
- Configure the AZURE_CREDENTIALS secret as described above
- Ensure the secret has valid JSON format
- Verify the service principal has contributor role on your subscription

### Workflow fails during Terraform apply
- Check Azure quotas for Container Apps and Container Registry in your region
- Verify the service principal has necessary permissions
- Review the deployment.log artifact for detailed error messages

### Container Registry push fails
- Ensure Docker daemon is running in the workflow (handled automatically)
- Check ACR service is available in your Azure region
- Verify network connectivity (usually not an issue in GitHub Actions)

### Frontend not accessible after deployment
- Wait 2-3 minutes for DNS propagation
- Check container app status:
  ```bash
  az containerapp show --name <app-name> --resource-group <rg-name>
  ```
- Review container logs:
  ```bash
  az containerapp logs show --name <app-name> --resource-group <rg-name> --tail 50
  ```

## Cost Considerations

The workflow runs on GitHub-hosted runners:
- **Free tier**: 2,000 minutes/month for private repos
- **Typical run time**: 10-15 minutes per deployment
- **Cost**: Free for public repos, included in free tier for private repos

Azure resources costs are separate and depend on usage (see main README).

## Security Best Practices

1. **Never commit secrets** to the repository
2. **Rotate service principal credentials** periodically
3. **Use least-privilege access** - limit service principal scope to specific resource group
4. **Review workflow runs** for any exposed sensitive data
5. **Enable branch protection** to prevent unauthorized workflow modifications
6. **Use environments** for production deployments (already configured)

## Customization

To customize the workflow:

### Change Terraform version
Edit the `TERRAFORM_VERSION` environment variable at the top of the workflow file.

### Add staging environment
1. Duplicate the workflow file as `frontend-deploy-staging.yml`
2. Change the `environment` value to `staging`
3. Update branch trigger to `develop` or your staging branch
4. Configure separate Azure credentials for staging in repository secrets

### Skip specific paths
Modify the `paths` filter under the `push` trigger to exclude certain directories.

### Add notifications
Add steps to send notifications to Slack, Teams, or email after deployment.

## Related Documentation

- [Frontend Deployment Guide](frontend-deployment.md) - Detailed deployment instructions
- [Frontend Quick Start](../QUICKSTART-FRONTEND.md) - Quick setup guide
- [Frontend Usage Guide](frontend-usage.md) - How to use the deployed frontend
- [setup-frontend-complete.sh](../setup-frontend-complete.sh) - Deployment script source
